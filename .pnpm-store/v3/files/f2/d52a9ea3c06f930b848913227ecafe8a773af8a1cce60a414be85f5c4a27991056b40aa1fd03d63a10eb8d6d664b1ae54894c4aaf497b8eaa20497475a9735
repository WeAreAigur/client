import B,{createContext as q,createRef as ie,useContext as z,useEffect as J,useMemo as D,useReducer as ye,useRef as V,useState as ce}from"react";import{match as w}from'../../utils/match.js';import{forwardRefWithAs as $,render as Y,Features as Q}from'../../utils/render.js';import{optionalRef as Ee,useSyncRefs as U}from'../../hooks/use-sync-refs.js';import{useId as W}from'../../hooks/use-id.js';import{Keys as _}from'../keyboard.js';import{isDisabledReactIssue7711 as fe}from'../../utils/bugs.js';import{getFocusableElements as ee,Focus as H,focusIn as N,isFocusableElement as be,FocusableMode as Se,FocusResult as te}from'../../utils/focus-management.js';import{OpenClosedProvider as ge,State as X,useOpenClosed as de}from'../../internal/open-closed.js';import{useResolveButtonType as Ae}from'../../hooks/use-resolve-button-type.js';import{useOutsideClick as Re}from'../../hooks/use-outside-click.js';import{getOwnerDocument as Ie}from'../../utils/owner.js';import{useOwnerDocument as oe}from'../../hooks/use-owner.js';import{useEventListener as Ce}from'../../hooks/use-event-listener.js';import{Hidden as re,Features as ne}from'../../internal/hidden.js';import{useEvent as S}from'../../hooks/use-event.js';import{useTabDirection as Pe,Direction as k}from'../../hooks/use-tab-direction.js';import'../../utils/micro-task.js';import{useLatestValue as ve}from'../../hooks/use-latest-value.js';import{useIsoMorphicEffect as Oe}from'../../hooks/use-iso-morphic-effect.js';var Me=(p=>(p[p.Open=0]="Open",p[p.Closed=1]="Closed",p))(Me||{}),Le=(t=>(t[t.TogglePopover=0]="TogglePopover",t[t.ClosePopover=1]="ClosePopover",t[t.SetButton=2]="SetButton",t[t.SetButtonId=3]="SetButtonId",t[t.SetPanel=4]="SetPanel",t[t.SetPanelId=5]="SetPanelId",t))(Le||{});let Fe={[0]:n=>({...n,popoverState:w(n.popoverState,{[0]:1,[1]:0})}),[1](n){return n.popoverState===1?n:{...n,popoverState:1}},[2](n,r){return n.button===r.button?n:{...n,button:r.button}},[3](n,r){return n.buttonId===r.buttonId?n:{...n,buttonId:r.buttonId}},[4](n,r){return n.panel===r.panel?n:{...n,panel:r.panel}},[5](n,r){return n.panelId===r.panelId?n:{...n,panelId:r.panelId}}},le=q(null);le.displayName="PopoverContext";function Z(n){let r=z(le);if(r===null){let p=new Error(`<${n} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(p,Z),p}return r}let ae=q(null);ae.displayName="PopoverAPIContext";function ue(n){let r=z(ae);if(r===null){let p=new Error(`<${n} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(p,ue),p}return r}let se=q(null);se.displayName="PopoverGroupContext";function Te(){return z(se)}let pe=q(null);pe.displayName="PopoverPanelContext";function he(){return z(pe)}function Be(n,r){return w(r.type,Fe,n,r)}let xe="div",De=$(function(r,p){var x;let C=V(null),R=U(p,Ee(e=>{C.current=e})),O=V([]),t=ye(Be,{popoverState:1,buttons:O,button:null,buttonId:null,panel:null,panelId:null,beforePanelSentinel:ie(),afterPanelSentinel:ie()}),[{popoverState:o,button:a,buttonId:v,panel:c,panelId:M,beforePanelSentinel:T,afterPanelSentinel:d},i]=t,u=oe((x=C.current)!=null?x:a),f=D(()=>{if(!a||!c)return!1;for(let K of document.querySelectorAll("body > *"))if(Number(K==null?void 0:K.contains(a))^Number(K==null?void 0:K.contains(c)))return!0;let e=ee(),l=e.indexOf(a),A=(l+e.length-1)%e.length,b=(l+1)%e.length,G=e[A],me=e[b];return!c.contains(G)&&!c.contains(me)},[a,c]),g=ve(v),y=ve(M),L=D(()=>({buttonId:g,panelId:y,close:()=>i({type:1})}),[g,y,i]),I=Te(),F=I==null?void 0:I.registerPopover,j=S(()=>{var e;return(e=I==null?void 0:I.isFocusWithinPopoverGroup())!=null?e:(u==null?void 0:u.activeElement)&&((a==null?void 0:a.contains(u.activeElement))||(c==null?void 0:c.contains(u.activeElement)))});J(()=>F==null?void 0:F(L),[F,L]),Ce(u==null?void 0:u.defaultView,"focus",e=>{var l,A,b,G;o===0&&(j()||!a||!c||e.target!==window&&((A=(l=T.current)==null?void 0:l.contains)!=null&&A.call(l,e.target)||(G=(b=d.current)==null?void 0:b.contains)!=null&&G.call(b,e.target)||i({type:1})))},!0),Re([a,c],(e,l)=>{i({type:1}),be(l,Se.Loose)||(e.preventDefault(),a==null||a.focus())},o===0);let h=S(e=>{i({type:1});let l=(()=>e?e instanceof HTMLElement?e:"current"in e&&e.current instanceof HTMLElement?e.current:a:a)();l==null||l.focus()}),s=D(()=>({close:h,isPortalled:f}),[h,f]),m=D(()=>({open:o===0,close:h}),[o,h]),E=r,P={ref:R};return B.createElement(le.Provider,{value:t},B.createElement(ae.Provider,{value:s},B.createElement(ge,{value:w(o,{[0]:X.Open,[1]:X.Closed})},Y({ourProps:P,theirProps:E,slot:m,defaultTag:xe,name:"Popover"}))))}),He="button",ke=$(function(r,p){let C=W(),{id:R=`headlessui-popover-button-${C}`,...O}=r,[t,o]=Z("Popover.Button"),{isPortalled:a}=ue("Popover.Button"),v=V(null),c=`headlessui-focus-sentinel-${W()}`,M=Te(),T=M==null?void 0:M.closeOthers,i=he()!==null;J(()=>{if(!i)return o({type:3,buttonId:R}),()=>{o({type:3,buttonId:null})}},[i,R,o]);let[u]=ce(()=>Symbol()),f=U(v,p,i?null:e=>{if(e)t.buttons.current.push(u);else{let l=t.buttons.current.indexOf(u);l!==-1&&t.buttons.current.splice(l,1)}t.buttons.current.length>1&&console.warn("You are already using a <Popover.Button /> but only 1 <Popover.Button /> is supported."),e&&o({type:2,button:e})}),g=U(v,p),y=oe(v),L=S(e=>{var l,A,b;if(i){if(t.popoverState===1)return;switch(e.key){case _.Space:case _.Enter:e.preventDefault(),(A=(l=e.target).click)==null||A.call(l),o({type:1}),(b=t.button)==null||b.focus();break}}else switch(e.key){case _.Space:case _.Enter:e.preventDefault(),e.stopPropagation(),t.popoverState===1&&(T==null||T(t.buttonId)),o({type:0});break;case _.Escape:if(t.popoverState!==0)return T==null?void 0:T(t.buttonId);if(!v.current||(y==null?void 0:y.activeElement)&&!v.current.contains(y.activeElement))return;e.preventDefault(),e.stopPropagation(),o({type:1});break}}),I=S(e=>{i||e.key===_.Space&&e.preventDefault()}),F=S(e=>{var l,A;fe(e.currentTarget)||r.disabled||(i?(o({type:1}),(l=t.button)==null||l.focus()):(e.preventDefault(),e.stopPropagation(),t.popoverState===1&&(T==null||T(t.buttonId)),o({type:0}),(A=t.button)==null||A.focus()))}),j=S(e=>{e.preventDefault(),e.stopPropagation()}),h=t.popoverState===0,s=D(()=>({open:h}),[h]),m=Ae(r,v),E=i?{ref:g,type:m,onKeyDown:L,onClick:F}:{ref:f,id:t.buttonId,type:m,"aria-expanded":r.disabled?void 0:t.popoverState===0,"aria-controls":t.panel?t.panelId:void 0,onKeyDown:L,onKeyUp:I,onClick:F,onMouseDown:j},P=Pe(),x=S(()=>{let e=t.panel;if(!e)return;function l(){w(P.current,{[k.Forwards]:()=>N(e,H.First),[k.Backwards]:()=>N(e,H.Last)})===te.Error&&N(ee().filter(b=>b.dataset.headlessuiFocusGuard!=="true"),w(P.current,{[k.Forwards]:H.Next,[k.Backwards]:H.Previous}),{relativeTo:t.button})}l()});return B.createElement(B.Fragment,null,Y({ourProps:E,theirProps:O,slot:s,defaultTag:He,name:"Popover.Button"}),h&&!i&&a&&B.createElement(re,{id:c,features:ne.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:x}))}),Ge="div",we=Q.RenderStrategy|Q.Static,_e=$(function(r,p){let C=W(),{id:R=`headlessui-popover-overlay-${C}`,...O}=r,[{popoverState:t},o]=Z("Popover.Overlay"),a=U(p),v=de(),c=(()=>v!==null?v===X.Open:t===0)(),M=S(i=>{if(fe(i.currentTarget))return i.preventDefault();o({type:1})}),T=D(()=>({open:t===0}),[t]);return Y({ourProps:{ref:a,id:R,"aria-hidden":!0,onClick:M},theirProps:O,slot:T,defaultTag:Ge,features:we,visible:c,name:"Popover.Overlay"})}),Ne="div",Ke=Q.RenderStrategy|Q.Static,Ue=$(function(r,p){let C=W(),{id:R=`headlessui-popover-panel-${C}`,focus:O=!1,...t}=r,[o,a]=Z("Popover.Panel"),{close:v,isPortalled:c}=ue("Popover.Panel"),M=`headlessui-focus-sentinel-before-${W()}`,T=`headlessui-focus-sentinel-after-${W()}`,d=V(null),i=U(d,p,s=>{a({type:4,panel:s})}),u=oe(d);Oe(()=>(a({type:5,panelId:R}),()=>{a({type:5,panelId:null})}),[R,a]);let f=de(),g=(()=>f!==null?f===X.Open:o.popoverState===0)(),y=S(s=>{var m;switch(s.key){case _.Escape:if(o.popoverState!==0||!d.current||(u==null?void 0:u.activeElement)&&!d.current.contains(u.activeElement))return;s.preventDefault(),s.stopPropagation(),a({type:1}),(m=o.button)==null||m.focus();break}});J(()=>{var s;r.static||o.popoverState===1&&((s=r.unmount)!=null?s:!0)&&a({type:4,panel:null})},[o.popoverState,r.unmount,r.static,a]),J(()=>{if(!O||o.popoverState!==0||!d.current)return;let s=u==null?void 0:u.activeElement;d.current.contains(s)||N(d.current,H.First)},[O,d,o.popoverState]);let L=D(()=>({open:o.popoverState===0,close:v}),[o,v]),I={ref:i,id:R,onKeyDown:y,onBlur:O&&o.popoverState===0?s=>{var E,P,x,e,l;let m=s.relatedTarget;!m||!d.current||(E=d.current)!=null&&E.contains(m)||(a({type:1}),(((x=(P=o.beforePanelSentinel.current)==null?void 0:P.contains)==null?void 0:x.call(P,m))||((l=(e=o.afterPanelSentinel.current)==null?void 0:e.contains)==null?void 0:l.call(e,m)))&&m.focus({preventScroll:!0}))}:void 0,tabIndex:-1},F=Pe(),j=S(()=>{let s=d.current;if(!s)return;function m(){w(F.current,{[k.Forwards]:()=>{var P;N(s,H.First)===te.Error&&((P=o.afterPanelSentinel.current)==null||P.focus())},[k.Backwards]:()=>{var E;(E=o.button)==null||E.focus({preventScroll:!0})}})}m()}),h=S(()=>{let s=d.current;if(!s)return;function m(){w(F.current,{[k.Forwards]:()=>{var A;if(!o.button)return;let E=ee(),P=E.indexOf(o.button),x=E.slice(0,P+1),l=[...E.slice(P+1),...x];for(let b of l.slice())if(b.dataset.headlessuiFocusGuard==="true"||((A=o.panel)==null?void 0:A.contains(b))){let G=l.indexOf(b);G!==-1&&l.splice(G,1)}N(l,H.First,{sorted:!1})},[k.Backwards]:()=>{var P;N(s,H.Previous)===te.Error&&((P=o.button)==null||P.focus())}})}m()});return B.createElement(pe.Provider,{value:R},g&&c&&B.createElement(re,{id:M,ref:o.beforePanelSentinel,features:ne.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:j}),Y({ourProps:I,theirProps:t,slot:L,defaultTag:Ne,features:Ke,visible:g,name:"Popover.Panel"}),g&&c&&B.createElement(re,{id:T,ref:o.afterPanelSentinel,features:ne.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:h}))}),We="div",je=$(function(r,p){let C=V(null),R=U(C,p),[O,t]=ce([]),o=S(u=>{t(f=>{let g=f.indexOf(u);if(g!==-1){let y=f.slice();return y.splice(g,1),y}return f})}),a=S(u=>(t(f=>[...f,u]),()=>o(u))),v=S(()=>{var g;let u=Ie(C);if(!u)return!1;let f=u.activeElement;return(g=C.current)!=null&&g.contains(f)?!0:O.some(y=>{var L,I;return((L=u.getElementById(y.buttonId.current))==null?void 0:L.contains(f))||((I=u.getElementById(y.panelId.current))==null?void 0:I.contains(f))})}),c=S(u=>{for(let f of O)f.buttonId.current!==u&&f.close()}),M=D(()=>({registerPopover:a,unregisterPopover:o,isFocusWithinPopoverGroup:v,closeOthers:c}),[a,o,v,c]),T=D(()=>({}),[]),d=r,i={ref:R};return B.createElement(se.Provider,{value:M},Y({ourProps:i,theirProps:d,slot:T,defaultTag:We,name:"Popover.Group"}))}),Rt=Object.assign(De,{Button:ke,Overlay:_e,Panel:Ue,Group:je});export{Rt as Popover};
